Настройка локальной сети в VirtualBox.

В качестве роутеров и клиентских машин выступает Ubuntu server. В VirtualBox устанавливается одни такой сервер, а затем клонируется на несколько.

За управление сетью на сервере отвечает демон systemd-networkd. На обычных десктопах за это отвечает демон NetworkManager.

################################################################################
Конфигурация systemd-networkd вручную.

Интерфейс сервера можно сконфигурировать вручную, т.е. задать статический IP-адрес, а можно сделать так, чтобы адрес назначался DHCP-сервером в сети. Сначала сконфигурируем интерфейсы клиента и сервера вручную.

Сделаем 2 клона исходной системы. Один назовём pc1, другой - router1. В настройках каждого устанавливаем по 2 интерфейса: один - NAT, другой - внутренняя сеть.

Подключаемся к серверу и клиенту через ssh.

Посмотреть доступные интерфейсы можно командой:

\$ ip link

Увидеть, какие из интерфейсов имеют IP-адрес, можно командой:

\$ ip address

Мы видим, что интерфейс enp0s3 имеет адрес, значит это он смотрит наружу и через него мы подключается по ssh. Интерфейс enp0s8 не имеет IP-адреса, а значит именно он смотрит во внутреннюю сеть. Его и нужно сконфигурировать.

Путь pc1 имеет IP-адрес 192.168.1.1/24, шлюз - 192.168.1.254. Значит router1 должен иметь адрес 192.168.1.254.

За работу с сетью на сервере (без NetworkManager) отвечает демон systemd-networkd. Файлы конфигурации интерфейсов лежат в /etc/systemd/network. Сейчас эта папка пустая. Файлы конфигурации должны оканчиваться на .network. Файлы имеют приоритет в зависимости от своего имени - те, которые начинаются с символов, код которых меньше, они и в приоритете над другими.

Создадим файл 10-static-enp0s8.network. Этот файл имеет определённый синтаксис.

Блок [Match] отвечает за соответствие интерфейсу. Напишем:

[Match]
Name=enp0s8

Блок [Network] отвечает за конфигурацию сети:

[Network]
Address=192.168.1.1/24
Gateway=192.168.1.254

Сохраним файл и перезапустим демон:

\$ sudo systemctl restart systemd-networkd

Для роутера файл конфигурации выглядит так:

[Match]
Name=enp0s8

[Network]
Address=192.168.1.254/24

Теперь пинганём наш роутер с клиентской машины:

\$ ping -c 3 192.168.1.254

Всё должно работать!

#######################################################################
Конфигурация systemd-networkd через Netplan.

Раньше настройка сети осуществлялась через файл /etc/network/interfaces. После редактирования этого файла нужно было перезапустить сервис:

$ sudo systemctl restart networking

С Ubuntu 18.04 конфигурирование происходит по-другому. Теперь используется Netplan, который использует yaml-файлы. Файлы конфигурации хранятся в /etc/netplan. В ubuntu netplan уже включён в дистрибутив. На других системах netplan устанавливается отдельно из официальных репозиториев. Пока netplan работает только с NetworkManager и Systemd-Networkd.

Чтобы сконфигурировать интерфейс enp0s8 со статическим IP, создадим файл 10-netcfg.yaml со следующим содержимым:

network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s8:
      dhcp4: no
      addresses: [192.168.1.254/24]

Далее необходимо проверить, что мы не ошиблись в конфиге. Запускаем команду:

$ sudo netplan try

Если всё норм, то будет предложено сохранить конфигурацию и перезапустить systemd-networkd по нажатию Enter. Нажимаем и проверяем. Всё работает!

Ссылка на примеры по работе с netplan:

https://netplan.io/examples
