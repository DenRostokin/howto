Firewall (сетевой экран) работает на сетевом и транспортном уровнях модели OSI. Он онализирует IP-адреса и порты в заголовках пакетов.

В качестве файервола на linux выступает iptables. Он конфигурируется через утилиту iptables.

В iptables используются 3 основных понятия:
1. Критерий
2. Действие
3. Счётчик

Чтобы посмотреть все правила, нужно ввести:

$ sudo iptables -S

Пакет, пришедший на сетевой интерфейс, проходит по одному из двух путей:

1. PREROUTING -> INPUT -> OUTPUT -> POSTROUTING (пакет обрабатывается локальным приложением)
2. PREROUTING -> FORWARD -> POSTROUTING (пакет является транзитным)

Каждый элемент пути - это цепочка. Цепочки состоят из таблиц.

В PREROUTING добавляются правила, которые нужны до принятия решения, куда пойдёт пакет, т.к. будет ли он транзитным или нет.
В INPUT удобно добавлять правила для фильтрации, т.е. для ограничения доступа.
В OUTPUT добавляются правила для ответов от приложений.
В POSTROUTING удобно работать со всеми пакетами (транзитными и нет). В этой цепочке устанавливаются правила для NAT.
FORWARD используется для ограничения доступа транзитных пакетов.

######################################
Цепочка PREROUTING состоит из 4-х таблиц:
1. raw. Здесь задаётся определённая маркировка пакета, для которого дальнейшее изменение не требуется!!!
2. contract. Таблица определения состояния. У пакета есть различные состояния (new, established, invalid и т.д.)
3. mangle. Чаще всего не применяется!!! В ней модифицируются поля TTL, TOS и MARK
4. nat. Используется для преобразования сетевый адресов.

Для просмотра таблиц в iptables вводим команду:

$ sudo iptables -L

По умолчанию выводятся только таблицы filter, которые есть лишь в цепочках INPUT, FORWARD и OUTPUT.

Чтобы вывести другие таблицы, например, таблицу nat, используем ключ -t:

$sudo iptables -L -t nat

Для verbose режима используется ключ -v. Это нужно для вывода большего количества параметров в таблице:

$ sudo iptables -L -t nat -v

Вывод данной команды выглядит следующим образом:

pkts  bytes  target  prot  opt  in  out  source  destination

pkts и bytes - это количество пакетов и байт, попавших под определённое правило
target - это действие, которое будет делаться с пакетами
in и out - это интерфейсы
source - это IP, по которому пришёл пакет
destination - это IP, которому предназначается пакет

Ключ -vv используется для ещё большего вывода параметров.

Ключи -X и -F используются для очистки таблиц.

При выводе таблиц мы видим записи вида: (police ACCEPT). Это политика по умолчанию.

Полика по умолчанию задаётся через ключ: -P <ИМЯ_ЦЕПОЧКИ> <ПОЛИТИКА_ПО_УМОЛЧАНИЮ>:

$ sudo iptables -P INPUT DROP

ACCEPT означает, что все пакеты, прошедшие через цепочку INPUT, будут приниматься.
DROP отбрасывает все пакеты.
