Firewall (сетевой экран) работает на сетевом и транспортном уровнях модели OSI. Он онализирует IP-адреса и порты в заголовках пакетов.

В качестве файервола на linux выступает iptables. Он конфигурируется через утилиту iptables.

В iptables используются 3 основных понятия:
1. Критерий
2. Действие
3. Счётчик

Чтобы посмотреть все правила, нужно ввести:

$ sudo iptables -S

Посмотреть правила для всех цепочек:

$ sudo iptables -L

Посмотреть правила для конкретной цепочки, например, INPUT:

$ sudo iptables -L INPUT

Для очистки правил во всех цепочках используется команда:

$ sudo iptables -F

Или для определённой цепочки, например, INPUT:

$ sudo iptables -F INPUT

Пакет, пришедший на сетевой интерфейс, проходит по одному из двух путей:

1. PREROUTING -> INPUT -> OUTPUT -> POSTROUTING (пакет обрабатывается локальным приложением)
2. PREROUTING -> FORWARD -> POSTROUTING (пакет является транзитным)

Каждый элемент пути - это цепочка. Цепочки состоят из таблиц.

В PREROUTING добавляются правила, которые нужны до принятия решения, куда пойдёт пакет, т.к. будет ли он транзитным или нет.
В INPUT удобно добавлять правила для фильтрации, т.е. для ограничения доступа.
В OUTPUT добавляются правила для ответов от приложений.
В POSTROUTING удобно работать со всеми пакетами (транзитными и нет). В этой цепочке устанавливаются правила для NAT.
FORWARD используется для ограничения доступа транзитных пакетов.

######################################
Цепочка PREROUTING состоит из 4-х таблиц:
1. raw. Здесь задаётся определённая маркировка пакета, для которого дальнейшее изменение не требуется!!!
2. conntract. Таблица определения состояния. У пакета есть различные состояния (new, established, invalid и т.д.)
3. mangle. Чаще всего не применяется!!! В ней модифицируются поля TTL, TOS и MARK
4. nat. Используется для преобразования сетевый адресов.

Для просмотра таблиц в iptables вводим команду:

$ sudo iptables -L

По умолчанию выводятся только таблицы filter, которые есть лишь в цепочках INPUT, FORWARD и OUTPUT.

Чтобы вывести другие таблицы, например, таблицу nat, используем ключ -t:

$sudo iptables -L -t nat

Для verbose режима используется ключ -v. Это нужно для вывода большего количества параметров в таблице:

$ sudo iptables -L -t nat -v

Вывод данной команды выглядит следующим образом:

pkts  bytes  target  prot  opt  in  out  source  destination

pkts и bytes - это количество пакетов и байт, попавших под определённое правило
target - это действие, которое будет делаться с пакетами
in и out - это интерфейсы
source - это IP, по которому пришёл пакет
destination - это IP, которому предназначается пакет

Ключ -vv используется для ещё большего вывода параметров.

Ключи -X и -F используются для очистки таблиц.

При выводе таблиц мы видим записи вида: (police ACCEPT). Это политика по умолчанию. Если прибывающий пакет удовлетворяет критерию, то к нему применяется действие. Если же пакет не удовлетворяет ни одному из критериев, то к нему применяется политика по умолчанию!!!

Полика по умолчанию задаётся через ключ: -P <ИМЯ_ЦЕПОЧКИ> <ПОЛИТИКА_ПО_УМОЛЧАНИЮ>:

$ sudo iptables -P INPUT DROP

ACCEPT означает, что все пакеты, прошедшие через цепочку INPUT, будут приниматься.
DROP отбрасывает все пакеты.
MASQUERADE означает скрыть (маскировать) пакет.

Если для цепочки INPUT поставить политику по умолчанию DROP (на сервере), то перестанут идти пакеты не только от клиентов к серверу, но также и от сервера клиенту. Это происходит потому, что при ping мы отправляем клиенту echo-запрос, а от клиента получаем echo-ответ. Вот этот ответ и не может пройти через цепочку INPUT.

Даже не будут проходить пакеты на localhost!!!. Чтобы разрешить это, напишем:

$ sudo iptables -A INPUT -i lo -j ACCEPT

Пакеты на localhost идут!!!

Чтобы разрешить пакеты с ответом от клиента, нам нужно разрешить пакеты с состоянием RELATED и ESTABLISHED!!!

Добавить команду в iptables можно с помощью ключа -A:

$ sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

По умолчанию, правило записывается в таблицу filter!!! Если нужно записать правило в какую-то другую таблицу, то используется ключ -t:

$ sudo iptables -t nat -A INPUT <правило>

Для удаление правил из таблицы вместо ключа -A используется ключ -D.

############################################
Есть 3 типа NAT:
1. MASQUERADE
2. SNAT
3. DNAT

1. Для маскировки пакетов в цепочке POSTROUTING таблицы NAT нужно выполнить следующее:

$ sudo iptables -t nat -A POSTROUTING -o <interface> -s <subnet 192.168.1.1/24> -j MASQUERADE

2. Если у нас на роутере используется статический IP-адрес для интерфейса локальной сети, откуда приходят forward-пакеты, то имеет смысл разрешить не MASQUERADE правило, а SNAT. Это делается для экономии ресурсов компа.

$ sudo iptables -t nat -A POSTROUTING -o <interface> -s <subnet 192.168.1.1/24> -j SNAT --to-source <IP of the interface>

3. DNAT используется для доступа из интернета на компы, находящиеся за роутером в локальной сети.

$ sudo iptables -t nat -A PREROUTING -i <interface> -p tcp --dport 3000 -j DNAT --to-destination <IP-address of the local machine>

############################################
Все указанные настройки iptables сохранятся только до перезагрузки. После перезагрузки все изменения будут стёрты. Для сохранения используется команда iptables-save (как минимум, в Utuntu и Arch Linux). Эта команда сохраняет изменения в файл.

$ sudo iptables-save > <file>

Чтобы восстановить iptables-правила есть команда iptables-restore:

$ sudo iptables-restore < <file>

Чтобы правила iptables восстанавливались при загрузке системы, нужно сохранить настройки iptables в /etc/iptables/:

$ sudo iptables-save > /etc/iptables/rules.v4

Теперь после перезагрузки системы правила будут автоматически загружаться из этого файла!!!

###########################################
Ресурсы:
1. https://www.nairabytes.net/81-linux/418-how-to-set-up-a-nat-router-on-ubuntu-server-16-04
2. https://upcloud.com/community/tutorials/configure-iptables-ubuntu/
3. http://hutpu4.net/linux-open-source/princip-raboty-i-osnovy-ispolzovaniya-iptables.html
4. https://www.youtube.com/watch?v=SYM5MvV4VIk&t=1069s
