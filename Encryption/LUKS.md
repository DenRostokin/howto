LUKS - это спецификация шифрования дисков в Linux. Для шифрования используется система шифрования дисков dm-crypt, которая в свою очередь использует другую подсистему ядра linux: dm (device mapper). DM позволяет создавать виртуальные блочные устройства. При обращении к таким устройствам выполняется ряд действий, в число которых обычно входит чтение/запись данных с других блочных устройств. DM используется в том числе и для реализации LVM. Подсистемой dm можно управлять вручную через утилиту dmsetup! Виртуальное блочное устройство создаётся в каталоге /dev/mapper. Данные на реальном устройстве будут лежать всегда в зашифрованном виде, а вот в виртуальном они будут расшифрованы. Если данные записываются на диск, то они шифруются на лету, если считываются, то расшифровываются. Таким образом осуществляется прозрачное шифрование для пользователя.

Перед тем, как использовать cryptsetup, необходимо убедиться, что загружен модуль ядра dm-crypt!

Проверить это можно командой lsmod. В выводе должен присутствовать модуль dm_crypt. Если его нет, то нужно загрузить его командой:

$ sudo modprobe dm-crypt

***
Для работы с зашифрованным устройством используется утилита cryptsetup. Синтаксис запуска команды такой:

$ cryptsetup опции операция параметры_операции

Рассмотрим основные операции, которые можно сделать с помощью этой утилиты:

    luksFormat - создать зашифрованный раздел luks linux;
    luksOpen - подключить виртуальное устройство (нужен ключ);
    luksClose - закрыть виртуальное устройство luks linux;
    luksAddKey - добавить ключ шифрования;
    luksRemoveKey - удалить ключ шифрования;
    luksUUID - показать UUID раздела;
    luksDump - создать резервную копию заголовков LUKS.

***
Создадим шифрованную флешку!

Перед тем, как создать шифрованный раздел, необходимо затереть существующую файловую систему:

$ sudo wipefs --all /dev/sdb

Перед началом создания шифрованного раздела необходимо затереть всю предыдущую информацию. По-хорошему, нужно сделать 3 прохода со случайными данными, что я вляется довольно надёжным способом защиты устройства против форензики. Команда ниже занимается в среднем 30 минут одного прохода для диска в 20GB:

$ sudo shred --verbose --random-source=/dev/urandom --iterations=3 /dev/sdc

Можно поступить хитрее. Создать на устройстве LUKS раздел, октрыть его, заполнить нулями и закрыть. Таким образом у нас получатся рандомные данные, кроме LUKS-хэдера, который остаётся незашифрованным. Его можно затереть с помощью /dev/urandom.

$ sudo cryptsetup luksFormat --hash=sha512 --key-size=512 --cipher=aes-xts-plain64 --verify-passphrase /dev/sdc

На этом шаге можно задать простой пароль, т.к. в дальнейшем LUKS-хэдер будет затёрт. Данная процедура нужна только для затирания устройства.

Откроем зашифрованное устройство:

$ sudo cryptsetup luksOpen /dev/sdc usb

Запишем устройство нулями:

$ sudo dd if=/dev/zero of=/dev/mapper/usb bs=1M

Хотя это таже занимает приличное количество времени!

Закроем диск:

$ sudo cryptsetup luksClose usb. Теперь устройство заполнено рандомными данными за исключением LUKS-хэдера. Обычно хэдер занимает несколько мегабайт, поэтому затрём первые 10 мегабайт диска:

$ sudo dd if=/dev/urandom of=/dev/sdc bs=512 count=20480 status=progress

Чтобы увидеть, что хэдер был затёрт, можно использовать команду:

$ sudo hexdump /dev/sda | less

После этого нужно заново создать шифрованное устройство и открыть его.  Теперь нужно отформатировать устройство в ext4 файловой системе (т.к. данная флешка будет открываться тольк на linux):

$ sudo mkfs.ext4 /dev/mapper/usb

Затем можно примонтировать замаппленое устройство и записывать на него всю информацию:


